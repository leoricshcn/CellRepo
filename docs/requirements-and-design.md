# Discord 任务管理机器人：需求与设计分析

## 3.1 需求与方案确认

### 3.1.1 角色与权限矩阵
| 角色             | 权限/职责                                                         |
| ---------------- | ------------------------------------------------------------------ |
| 任务创建者       | - 执行 `/task` 创建任务<br>- 需要在 `tasks` 频道创建帖子与提及成员 |
| 任务执行者       | - 被 `/task` 指派时自动收到 @ 提醒<br>- 可使用 `/listask` 查看任务 |
| 普通成员         | - 默认仅可执行 `/listask` 查看自己任务                             |
| 服务器管理员/运维 | - 维护机器人配置（token、频道 ID 等）<br>- 处理权限不足等异常情形   |
| 机器人自身       | - 具备读取/发送消息、创建帖子、管理命令的权限                     |

- `/task` 仅限任务创建者或具备相应权限的成员可使用。
- `/listask` 所有成员都可使用，但仅返回与调用者相关的任务。
- 机器人需要确保调用者对 `tasks` 频道拥有必要权限，否则返回错误提示。

### 3.1.2 任务流程时序概览
```
用户 -> Discord Slash Command: 触发 `/task` 或 `/listask`
Discord -> 机器人交互端点: 发送 Interaction 请求
机器人 -> 命令路由器: 根据命令名称选择处理器
命令处理器 -> 参数校验/权限模块: 校验输入与权限
命令处理器 -> Discord API: 执行创建帖子或读取帖子列表
Discord API -> 命令处理器: 返回成功/失败结果
命令处理器 -> 响应格式化模块: 生成反馈消息
机器人 -> Discord: 返回 Interaction Response
Discord -> 用户: 展示命令执行结果
```

- `/task` 成功路径包含帖子创建与 @ 提醒；失败时返回错误响应。
- `/listask` 主要执行查询、过滤与格式化展示。

### 3.1.3 配置项清单
- `DISCORD_TOKEN`: 机器人认证使用的 Bot Token。
- `DISCORD_PUBLIC_KEY`: 验证 Interaction 请求签名所需的公钥。
- `DISCORD_APPLICATION_ID`: 进行命令注册时所需的应用 ID。
- `TASKS_CHANNEL_ID`: 用于创建与读取任务帖子的频道 ID。
- `DEFAULT_TIMEZONE`: 格式化日期时使用的默认时区（如 `Asia/Shanghai`）。
- `DEFAULT_DATE_FORMAT`: 截止时间展示格式（如 `yyyy-LL-dd HH:mm`）。
- `ALLOWED_TASK_ROLES`: 允许执行 `/task` 的角色 ID 列表（可选）。
- `CACHE_STORAGE_PATH` 或 `D1_DATABASE_ID`: 当启用缓存/数据库时使用的配置。
- `LOG_LEVEL`: 控制日志输出粒度。

### 3.1.4 缓存/数据库评估
- **方案选择**：
  - 初始阶段可直接读取 Discord 帖子满足需求，复杂度低。
  - 当任务数量增多或需要快速过滤时，可使用 Cloudflare D1/SQLite 作为缓存层。
- **缓存内容**：
  - 存储任务元数据：任务 ID、帖子链接、截止时间、指派成员、创建时间。
  - 在创建任务时写入缓存，`/listask` 查询时优先从缓存获取，再 fallback 到 Discord API。
- **同步策略**：
  - 定期扫描 `tasks` 频道，确保缓存与实际帖子保持一致。
  - 当检测到帖子被编辑或关闭时更新缓存状态。
- **风险与应对**：
  - 缓存过期导致数据不一致 → 设定 TTL 与手动刷新命令。
  - 额外维护成本 → 在首版上线时可暂缓使用缓存，待性能瓶颈出现再启用。
