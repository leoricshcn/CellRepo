# Discord 任务管理机器人开发计划

## 1. 项目背景与目标
- 汇总《user requirements.md》与推荐技术栈，构建一个基于 Discord 的任务管理机器人。
- 第一阶段聚焦 Slash Command `/task` 与 `/listask`，确保任务创建与查询体验顺畅。

## 2. 项目里程碑概览
1. **需求与方案确认**：梳理核心流程、权限、数据模型与配置项。
2. **基础设施搭建**：初始化代码仓库、配置 TypeScript、Discord.js、环境变量管理与格式化工具。
3. **命令注册与交互处理**：实现 Slash Command 的定义、注册与基础交互路由。
4. **`/task` 命令实现**：完成参数校验、权限检查、帖子创建与错误处理。
5. **`/listask` 命令实现**：拉取、过滤、排序任务列表并格式化输出。
6. **配置与存储支持**：实现频道 ID、时区等可配置项，以及可选的本地数据库同步。
7. **测试与质量保证**：完善单元测试、集成测试、Lint、类型检查与 CI。
8. **部署与运维**：准备 Cloudflare Workers 部署、环境变量、安全策略与监控报警。
9. **验收与文档**：根据验收标准完成功能验证，整理使用说明与运维手册。

## 3. 详细分步计划

### 3.1 需求与方案确认
1. ✅ 梳理角色与权限矩阵，明确 `/task` 与 `/listask` 的调用者与数据访问范围。
2. ✅ 绘制任务流程时序图：Slash Command -> 交互处理 -> Discord 频道操作。
3. ✅ 确定配置项清单：机器人 Token、公钥、`tasks` 频道 ID、默认时区与日期格式。
4. ✅ 评估是否引入 D1/SQLite 做任务索引缓存，为 `/listask` 查询优化做准备。

### 3.2 基础设施搭建
1. ✅ 初始化 Node.js + TypeScript 项目结构，配置 tsconfig、ESLint、Prettier、Jest。
2. ✅ 引入 Discord.js v14、@discordjs/rest、discord-api-types、dotenv、zod、Luxon/Day.js 等依赖。
3. ✅ 搭建基础目录结构：`src/commands`, `src/services`, `src/config`, `src/utils`。
4. ✅ 实现环境变量加载模块，约定 `.env.example` 格式。
5. ✅ 配置 GitHub Actions 进行 Lint、测试、类型检查。

### 3.3 命令注册与交互处理
1. ✅ 定义 `/task` 与 `/listask` Slash Command 的 schema（名称、描述、参数）。
2. ✅ 实现命令注册脚本，向 Discord 应用提交命令定义。
3. ✅ 在 Cloudflare Workers 或 Node 运行时建立 Interaction 处理入口，解析命令并路由到对应处理器。
4. ✅ 添加基础日志记录与错误处理框架。

### 3.4 `/task` 命令实现
1. ✅ 使用 zod 校验 `task_name`、`due_date`、`assignees` 参数合法性。
2. 调用 Discord API 在 `tasks` 频道创建帖子：
   - 标题遵循 `<task_name> | Due: <due_date>` 格式。
   - 正文包含任务描述、标准化截止时间与 @ 指派成员。
3. 校验调用者权限，缺失权限时返回友好提示。
4. 处理异常场景：频道缺失、成员不可 @、API 调用失败。
5. 向调用者返回成功确认消息，包含帖子链接与指派成员列表。

### 3.5 `/listask` 命令实现
1. 读取 `tasks` 频道内最近的帖子，或从缓存数据库中获取结构化任务数据。
2. 过滤包含调用者 @ 的帖子，解析标题与正文提取截止时间与创建时间。
3. 对结果按截止时间、创建时间排序。
4. 格式化输出列表，包含标题、创建时间、帖子链接与状态字段（如可根据标签判断）。
5. 当无任务时返回友好提示，并指导使用 `/task` 指派。

### 3.6 配置与存储支持
1. 将频道 ID、默认时区、日期格式等抽象为配置模块，可通过环境变量或配置文件注入。
2. 设计任务缓存的数据模型（如 SQLite 表结构），支持按用户查询。
3. 实现数据同步逻辑：创建任务时写入缓存，`/listask` 查询时优先走缓存，必要时回源 Discord。
4. 评估并集成 Redis（或 Cloudflare KV）用于缓存热门查询与速率限制。

### 3.7 测试与质量保证
1. 编写命令处理的单元测试，覆盖参数校验、权限失败、成功路径。
2. 使用 Jest + ts-jest 模拟 Discord API 响应，构建 `/task` 与 `/listask` 的集成测试。
3. 配置 ESLint、Prettier、TypeScript 检查在 CI 中自动执行。
4. 设置代码覆盖率门槛，持续监控关键模块的覆盖情况。

### 3.8 部署与运维
1. 使用 Wrangler 配置 Cloudflare Workers 项目，管理环境变量与密钥。
2. 编写部署脚本：自动化构建 TypeScript -> JavaScript，并推送到 Cloudflare Workers。
3. 若需要 Gateway 长连接，设计 Docker 容器方案并通过 Cloudflare Tunnel 暴露服务。
4. 集成 Sentry 或 Cloudflare Logs 捕获异常，配置告警通知渠道。
5. 制定速率限制与权限管理策略，防止滥用命令。

### 3.9 验收与文档
1. 根据验收标准逐项验证 `/task` 与 `/listask` 的行为与错误提示。
2. 编写使用手册：命令说明、配置指南、常见问题。
3. 整理运维手册：部署流程、监控指标、应急处理步骤。
4. 规划后续迭代：任务状态管理、提醒服务、外部系统集成等。

## 4. 风险与应对
- **Discord API 限流**：实现全局与用户级速率限制，缓存查询结果，避免频繁扫描频道。
- **权限与配置错误**：增加启动时自检，提示缺失的权限或配置。
- **时间格式复杂度**：统一使用 Luxon 处理时区与格式，提供配置项。
- **部署差异**：在本地、测试、生产环境中保持配置一致性，使用 `.env` + Wrangler 环境变量管理。

## 5. 成功指标
- Slash Command 响应成功率 ≥ 99%。
- `/task` 创建任务平均响应时间 ≤ 3 秒。
- `/listask` 查询平均响应时间 ≤ 3 秒，且结果排序准确。
- 错误提示覆盖常见失败场景，支持快速定位问题。

