# 功能规格说明：Discord 帖子邮件通知机器人

## 1. 背景
组织希望在 Discord 服务器中实时了解成员发布的新帖子，避免错过重要信息。现有的人工巡检方式效率低下，需要一个自动化机器人在成员发帖时及时通知管理员。

## 2. 目标
当 Discord 服务器中出现新帖子（包括文本消息、嵌入消息或附件）时，机器人自动向指定管理员邮箱发送提醒邮件，包含关键信息和访问链接，以便管理员快速响应。

## 3. 范围
- 覆盖所有需监控的 Discord 频道。
- 只处理在频道中新发布的帖子，不包括已存在消息的编辑或删除事件。
- 邮件通知发送至预先配置的管理员邮箱列表。
- 邮件通知通过外部邮件服务发送（例如 SMTP 服务或邮件 API）。

## 4. 角色与用户
- **普通成员**：在服务器频道中发帖的用户，无需额外操作。
- **管理员**：通过邮件接收提醒，点击链接查看帖子详情。
- **系统管理员**：负责配置机器人令牌、监控频道列表、邮件服务凭证及管理员邮箱列表。

## 5. 触发条件
1. 机器人已连接至目标 Discord 服务器，并具有读取消息历史和访问目标频道的权限。
2. 在受监控频道中检测到新帖子事件。

## 6. 功能需求
### FR1 监听帖子创建
- 机器人需监听 Discord 的消息创建事件（Message Create）。
- 支持配置需监听的频道 ID 列表；对不在列表中的频道忽略事件。

### FR2 收集帖子信息
- 记录发布者昵称、用户 ID、发布时间、频道名称与 ID。
- 获取消息正文、嵌入内容摘要及附件名称、链接。
- 构建可直接跳转到 Discord 消息的链接。

### FR3 邮件通知生成
- 以配置的邮件模板生成通知邮件，至少包含以下内容：
  - 邮件主题：`[Discord] <频道名称> 有新帖子`。
  - 邮件正文：发布者信息、消息内容摘要、附件列表、时间戳、访问链接。
- 支持对过长文本进行截断，并在正文中标注“内容已截断”。

### FR4 邮件发送
- 通过配置的邮件服务账户发送邮件。
- 支持同时发送给多个管理员邮箱，并在配置中决定使用收件人或密送方式。
- 若发送失败，记录失败原因并执行重试策略（至少重试 3 次，间隔 30 秒）。

### FR5 日志与监控
- 为每次邮件发送操作记录日志，包括成功与失败状态。
- 支持通过配置启用/禁用调试日志等级。
- 当连续发送失败超过设定阈值时，向系统管理员发送告警（可通过邮件或日志监控提醒）。

## 7. 非功能需求
- **可靠性**：机器人需保证在 Discord 断线后自动重连，并在重连后恢复监听。
- **安全性**：所有配置文件中敏感信息（机器人令牌、邮件凭证）必须通过环境变量或安全存储方式提供。
- **可扩展性**：支持后续扩展到其他通知渠道（如短信或即时通信）。
- **本地化**：邮件内容默认使用中文，需支持配置其他语言模板。

## 8. 配置项
- Discord 机器人令牌。
- 监控频道 ID 列表。
- 管理员邮箱列表。
- 邮件服务配置（SMTP 主机、端口、账户、凭证、加密方式）。
- 邮件模板路径或内置模板选择。
- 日志等级与重试策略参数（重试次数、间隔时间、失败阈值）。

## 9. 依赖与集成
- Discord API 权限：`GUILD_MESSAGES`、`MESSAGE_CONTENT` 等读取消息所需权限。
- 邮件服务提供商：SMTP 或第三方邮件发送 API。
- 日志系统：本地文件或集中化日志收集工具。

## 10. 验收标准
- 在配置好的频道中发布帖子，管理员邮箱收到包含正确内容的通知邮件。
- 对非监控频道的发帖不触发邮件。
- 邮件发送失败时记录日志，并能观察到重试行为。
- 断开机器人网络后，恢复连接时仍能继续发送通知。

## 11. 风险与假设
- 假设管理员邮箱可正常接收邮件，且邮件服务稳定可用。
- 若 Discord API 权限不足，将无法监听目标频道消息。
- 邮件发送延迟可能受第三方服务影响。

## 12. 后续扩展
- 支持根据关键词或频道标签过滤通知。
- 与工单系统集成，将发帖转为待办任务。
- 支持在邮件中嵌入消息截图或富文本格式。
